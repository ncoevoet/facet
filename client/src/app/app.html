<div class="flex flex-col h-screen">
  <!-- Toolbar -->
  <mat-toolbar class="shrink-0 !px-4 !bg-[var(--mat-sys-surface-container)] border-b border-[var(--mat-sys-outline-variant)]">
    <div class="flex items-center gap-3 w-full">
      <!-- Logo / Brand -->
      <a routerLink="/" class="flex items-center gap-2 no-underline text-inherit">
        <mat-icon>diamond</mat-icon>
        <span class="text-lg font-medium">Facet</span>
      </a>

      <!-- Nav links -->
      @if (auth.isAuthenticated()) {
        <nav class="hidden lg:flex items-center gap-1 ml-4">
          <a mat-button routerLink="/" routerLinkActive #rlGallery="routerLinkActive" [routerLinkActiveOptions]="{exact:true}" [style.color]="rlGallery.isActive ? 'var(--mat-sys-primary)' : ''">{{ 'nav.gallery' | translate }}</a>
          <a mat-button routerLink="/persons" routerLinkActive #rlPersons="routerLinkActive" [style.color]="rlPersons.isActive ? 'var(--mat-sys-primary)' : ''">{{ 'nav.persons' | translate }}</a>
          @if (auth.isEdition()) {
            <a mat-button routerLink="/compare" routerLinkActive #rlCompare="routerLinkActive" [style.color]="rlCompare.isActive ? 'var(--mat-sys-primary)' : ''">{{ 'nav.compare' | translate }}</a>
          }
          <a mat-button routerLink="/stats" routerLinkActive #rlStats="routerLinkActive" [style.color]="rlStats.isActive ? 'var(--mat-sys-primary)' : ''">{{ 'nav.stats' | translate }}</a>
        </nav>
      }

      <!-- Gallery type & sort (visible only on gallery route, lg+ to avoid toolbar cramping) -->
      @if (auth.isAuthenticated() && isGalleryRoute()) {
        <mat-form-field class="!hidden lg:!inline-flex w-52 ml-2" subscriptSizing="dynamic">
          <mat-label>{{ 'ui.filters.type' | translate }}</mat-label>
          <mat-select [value]="store.filters().type" (selectionChange)="onTypeChange($event.value)">
            <mat-option value="">{{ 'gallery.all_photos' | translate }}</mat-option>
            @for (t of store.types(); track t.id) {
              <mat-option [value]="t.id">{{ (t.id === 'top_picks' ? 'photo_types.top_picks' : 'category_names.' + t.id) | translate }} ({{ t.count }})</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <!-- Person multi-select -->
        @if (store.persons().length) {
          <mat-form-field class="!hidden lg:!inline-flex w-44 xl:w-52" subscriptSizing="dynamic">
            <mat-label>{{ 'gallery.person' | translate }}</mat-label>
            <mat-select
              multiple
              panelClass="person-select-panel"
              [value]="selectedPersonIds()"
              (selectionChange)="onPersonChange($event.value)"
            >
              <mat-select-trigger>
                <div class="flex items-center gap-1.5 overflow-hidden">
                  @for (p of selectedPersons(); track p.id) {
                    <img
                      [src]="p.id | personThumbnailUrl"
                      [matTooltip]="p.name || ('gallery.unknown_person' | translate)"
                      class="w-9 h-9 rounded-full object-cover shrink-0"
                      alt=""
                      loading="lazy"
                      (error)="$event.target.style.display='none'"
                    />
                  }
                </div>
              </mat-select-trigger>
              @for (p of store.persons(); track p.id) {
                <mat-option [value]="'' + p.id">
                  <div class="flex items-center gap-3">
                    <img
                      [src]="p.id | personThumbnailUrl"
                      class="w-14 h-14 rounded-full object-cover shrink-0"
                      alt=""
                      loading="lazy"
                      (error)="$event.target.style.display='none'"
                    />
                    <span class="text-sm">{{ p.name || ('gallery.unknown_person' | translate) }} ({{ p.face_count }})</span>
                  </div>
                </mat-option>
              }
            </mat-select>
          </mat-form-field>
        }

        <!-- Search -->
        <mat-form-field class="!hidden lg:!inline-flex w-44 xl:w-56" subscriptSizing="dynamic">
          <mat-icon matPrefix>search</mat-icon>
          <input
            matInput
            [placeholder]="'gallery.search_placeholder' | translate"
            [value]="store.filters().search"
            (keyup.enter)="onSearchChange($event)"
            (blur)="onSearchChange($event)"
          />
          @if (store.filters().search) {
            <button matSuffix mat-icon-button (click)="clearSearch()">
              <mat-icon>close</mat-icon>
            </button>
          }
        </mat-form-field>

      }

      <!-- Compare category selector (visible only on compare route, lg+) -->
      @if (auth.isAuthenticated() && isCompareRoute()) {
        <mat-form-field class="!hidden lg:!inline-flex w-52 ml-2" subscriptSizing="dynamic">
          <mat-label>{{ 'ui.filters.type' | translate }}</mat-label>
          <mat-select [value]="compareFilters.selectedCategory()" (selectionChange)="onCompareCategoryChange($event.value)">
            @for (t of store.types(); track t.id) {
              <mat-option [value]="t.id">{{ (t.id === 'top_picks' ? 'photo_types.top_picks' : 'category_names.' + t.id) | translate }} ({{ t.count }})</mat-option>
            }
          </mat-select>
        </mat-form-field>
      }

      <!-- Stats filters (visible only on stats route, lg+) -->
      @if (auth.isAuthenticated() && isStatsRoute()) {
        <mat-form-field class="!hidden lg:!inline-flex w-52 ml-2" subscriptSizing="dynamic">
          <mat-label>{{ 'ui.filters.type' | translate }}</mat-label>
          <mat-select [value]="statsFilters.filterCategory()" (selectionChange)="onStatsCategoryChange($event.value)">
            <mat-option value="">{{ 'gallery.all_photos' | translate }}</mat-option>
            @for (t of store.types(); track t.id) {
              <mat-option [value]="t.id">{{ (t.id === 'top_picks' ? 'photo_types.top_picks' : 'category_names.' + t.id) | translate }} ({{ t.count }})</mat-option>
            }
          </mat-select>
        </mat-form-field>
        <mat-form-field class="!hidden lg:!inline-flex w-44" subscriptSizing="dynamic">
          <mat-label>{{ 'stats.filter.date_from' | translate }}</mat-label>
          <input matInput type="date" [value]="statsFilters.dateFrom()" (change)="onStatsDateChange('from', $event)" />
        </mat-form-field>
        <mat-form-field class="!hidden lg:!inline-flex w-44" subscriptSizing="dynamic">
          <mat-label>{{ 'stats.filter.date_to' | translate }}</mat-label>
          <input matInput type="date" [value]="statsFilters.dateTo()" (change)="onStatsDateChange('to', $event)" />
        </mat-form-field>
      }

      <div class="flex-1"></div>

      <!-- Gallery: photo count + active filters + filter toggle (right side, lg+ only) -->
      @if (auth.isAuthenticated() && isGalleryRoute()) {
        <span class="!hidden lg:!inline text-sm opacity-70">{{ 'gallery.photo_count' | translate:{ count: store.total() } }}</span>

        <mat-form-field class="!hidden lg:!inline-flex w-48" subscriptSizing="dynamic">
          <mat-label>{{ 'gallery.sort' | translate }}</mat-label>
          <mat-select [value]="store.filters().sort" (selectionChange)="onSortChange($event.value)">
            @if (sortGroups(); as groups) {
              @for (group of groups; track group[0]) {
                <mat-optgroup [label]="group[0]">
                  @for (opt of group[1]; track opt.column) {
                    <mat-option [value]="opt.column">{{ opt.label }}</mat-option>
                  }
                </mat-optgroup>
              }
            } @else {
              <mat-option value="aggregate">{{ 'gallery.sort_aggregate' | translate }}</mat-option>
              <mat-option value="aesthetic">{{ 'gallery.sort_aesthetic' | translate }}</mat-option>
              <mat-option value="date_taken">{{ 'gallery.sort_date' | translate }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <button
          class="!hidden lg:!inline-flex"
          mat-icon-button
          (click)="toggleSortDirection()"
          [matTooltip]="store.filters().sort_direction === 'DESC' ? ('gallery.sort_desc' | translate) : ('gallery.sort_asc' | translate)"
        >
          <mat-icon>{{
            store.filters().sort_direction === 'DESC' ? 'arrow_downward' : 'arrow_upward'
          }}</mat-icon>
        </button>

        <button
          class="!hidden lg:!inline-flex"
          mat-icon-button
          (click)="store.slideshowActive.set(!store.slideshowActive())"
          [matTooltip]="'slideshow.start' | translate"
        >
          <mat-icon [style.color]="store.slideshowActive() ? 'var(--mat-sys-primary)' : ''">slideshow</mat-icon>
        </button>

        <button
          class="!hidden lg:!inline-flex"
          mat-icon-button
          (click)="store.filterDrawerOpen.set(!store.filterDrawerOpen())"
          [matBadge]="store.activeFilterCount() || null"
          matBadgeColor="primary"
          matBadgeSize="small"
          [matTooltip]="'gallery.filters' | translate"
        >
          <mat-icon [style.color]="store.filterDrawerOpen() ? 'var(--mat-sys-primary)' : ''">tune</mat-icon>
        </button>
      }

      <!-- Edition mode toggle (legacy single-user only) -->
      @if (auth.isAuthenticated() && !auth.isMultiUser() && auth.status()?.edition_enabled) {
        @if (auth.isEdition()) {
          <button mat-icon-button (click)="lockEdition()" [matTooltip]="'edition.lock_title' | translate">
            <mat-icon class="text-amber-400">lock_open</mat-icon>
          </button>
        } @else {
          <button mat-icon-button (click)="showEditionDialog()" [matTooltip]="'edition.unlock_title' | translate">
            <mat-icon>lock</mat-icon>
          </button>
        }
      }

      <!-- User menu (authenticated: account + language + logout) -->
      @if (auth.isAuthenticated()) {
        <button mat-icon-button [matMenuTriggerFor]="userMenu">
          <mat-icon>account_circle</mat-icon>
        </button>
        <mat-menu #userMenu="matMenu">
          @if (auth.status()?.display_name) {
            <div class="px-4 py-2 text-sm opacity-70">{{ auth.status()?.display_name }}</div>
          }
          <button mat-menu-item [matMenuTriggerFor]="langMenu">
            <mat-icon>language</mat-icon>
            {{ 'ui.switch_language' | translate }}
          </button>
          <button mat-menu-item [matMenuTriggerFor]="themeMenu">
            <mat-icon>palette</mat-icon>
            {{ 'ui.theme' | translate }}
          </button>
          <mat-divider />
          <button mat-menu-item (click)="logout()">
            <mat-icon>logout</mat-icon>
            {{ 'auth.logout' | translate }}
          </button>
        </mat-menu>
        <mat-menu #langMenu="matMenu">
          <button mat-menu-item (click)="switchLang('en')">English</button>
          <button mat-menu-item (click)="switchLang('fr')">Français</button>
          <button mat-menu-item (click)="switchLang('de')">Deutsch</button>
          <button mat-menu-item (click)="switchLang('it')">Italiano</button>
          <button mat-menu-item (click)="switchLang('es')">Español</button>
        </mat-menu>
        <mat-menu #themeMenu="matMenu">
          @for (t of themeService.THEMES; track t.id) {
            <button mat-menu-item (click)="themeService.setTheme(t.id)">
              <span class="inline-block w-4 h-4 rounded-full mr-2 align-middle" [style.background]="t.swatch"></span>
              {{ t.label }}
            </button>
          }
        </mat-menu>
      }

      <!-- Language menu (not authenticated) -->
      @if (!auth.isAuthenticated()) {
        <button mat-icon-button [matMenuTriggerFor]="langMenuAnon" [attr.aria-label]="'ui.switch_language' | translate">
          <mat-icon>language</mat-icon>
        </button>
        <mat-menu #langMenuAnon="matMenu">
          <button mat-menu-item (click)="switchLang('en')">English</button>
          <button mat-menu-item (click)="switchLang('fr')">Français</button>
          <button mat-menu-item (click)="switchLang('de')">Deutsch</button>
          <button mat-menu-item (click)="switchLang('it')">Italiano</button>
          <button mat-menu-item (click)="switchLang('es')">Español</button>
        </mat-menu>
        <!-- Theme menu (not authenticated) -->
        <button mat-icon-button [matMenuTriggerFor]="themeMenuAnon" [attr.aria-label]="'ui.theme' | translate">
          <mat-icon>palette</mat-icon>
        </button>
        <mat-menu #themeMenuAnon="matMenu">
          @for (t of themeService.THEMES; track t.id) {
            <button mat-menu-item (click)="themeService.setTheme(t.id)">
              <span class="inline-block w-4 h-4 rounded-full mr-2 align-middle" [style.background]="t.swatch"></span>
              {{ t.label }}
            </button>
          }
        </mat-menu>
      }

      <!-- Mobile nav toggle -->
      @if (auth.isAuthenticated()) {
        <button mat-icon-button class="lg:!hidden" [matMenuTriggerFor]="mobileNav">
          <mat-icon>menu</mat-icon>
        </button>
        <mat-menu #mobileNav="matMenu">
          <button mat-menu-item (click)="navigateTo('/')">
            <mat-icon>photo_library</mat-icon>
            {{ 'nav.gallery' | translate }}
          </button>
          <button mat-menu-item (click)="navigateTo('/persons')">
            <mat-icon>people</mat-icon>
            {{ 'nav.persons' | translate }}
          </button>
          @if (auth.isEdition()) {
            <button mat-menu-item (click)="navigateTo('/compare')">
              <mat-icon>tune</mat-icon>
              {{ 'nav.compare' | translate }}
            </button>
          }
          <button mat-menu-item (click)="navigateTo('/stats')">
            <mat-icon>bar_chart</mat-icon>
            {{ 'nav.stats' | translate }}
          </button>
        </mat-menu>
      }
    </div>
  </mat-toolbar>

  <!-- Mobile search bar (expandable, < md only) -->
  @if (auth.isAuthenticated() && isGalleryRoute() && mobileSearchOpen()) {
    <div class="lg:hidden flex items-center gap-2 px-3 py-2 bg-[var(--mat-sys-surface-container)] border-b border-[var(--mat-sys-outline-variant)]">
      <mat-icon class="opacity-60">search</mat-icon>
      <input
        class="flex-1 bg-transparent outline-none text-sm"
        [placeholder]="'gallery.search_placeholder' | translate"
        [value]="store.filters().search"
        (keyup.enter)="onSearchChange($event); mobileSearchOpen.set(false)"
        (blur)="onSearchChange($event)"
        autofocus
      />
      <button mat-icon-button (click)="clearSearch(); mobileSearchOpen.set(false)">
        <mat-icon>close</mat-icon>
      </button>
    </div>
  }


  <!-- Active filter chips bar (gallery route only, when filters are active) -->
  @if (auth.isAuthenticated() && isGalleryRoute() && (activeFilterChips().length || store.filters().similar_to)) {
    <div class="flex items-center gap-2 flex-wrap px-4 py-2 bg-[var(--mat-sys-surface-container)] border-b border-[var(--mat-sys-outline-variant)]">
      @if (store.filters().similar_to) {
        <div class="inline-flex items-center gap-1.5 pl-1 pr-1 py-0.5 rounded-full bg-[var(--mat-sys-secondary-container)] text-[var(--mat-sys-on-secondary-container)] text-xs font-medium">
          <img [src]="store.filters().similar_to | thumbnailUrl:48"
               class="w-7 h-7 rounded-full object-cover shrink-0"
               alt="" />
          <span class="opacity-70 pl-1">{{ 'similar.title' | translate }}</span>
          <mat-slider class="!w-24 !min-w-0" [min]="0" [max]="90" [step]="5" [discrete]="true">
            <input matSliderThumb
                   [value]="similaritySliderValue()"
                   (valueChange)="onSimilarityFilterChange($event)" />
          </mat-slider>
          <span class="font-medium w-8 text-right shrink-0">{{ similaritySliderValue() }}%</span>
          <button
            class="inline-flex items-center justify-center w-4 h-4 rounded-full hover:bg-black/20 transition-colors"
            (click)="clearSimilarFilter()"
          >
            <mat-icon class="!text-sm !w-3.5 !h-3.5 !leading-[14px]">close</mat-icon>
          </button>
        </div>
      }
      @for (chip of activeFilterChips(); track chip.id) {
        <div class="inline-flex items-center gap-1 pl-2.5 pr-1 py-0.5 rounded-full bg-[var(--mat-sys-secondary-container)] text-[var(--mat-sys-on-secondary-container)] text-xs font-medium">
          <span class="opacity-70">{{ chip.labelKey | translate }}</span>
          @if (chip.value) {
            <span class="mx-0.5">{{ chip.value }}</span>
          }
          <button
            class="inline-flex items-center justify-center w-4 h-4 rounded-full hover:bg-black/20 transition-colors"
            (click)="clearFilterChip(chip)"
          >
            <mat-icon class="!text-sm !w-3.5 !h-3.5 !leading-[14px]">close</mat-icon>
          </button>
        </div>
      }
      @if (activeFilterChips().length > 1) {
        <button class="text-xs opacity-60 hover:opacity-100 transition-opacity" (click)="store.resetFilters()">
          {{ 'gallery.reset_filters' | translate }}
        </button>
      }
    </div>
  }

  <!-- Main content -->
  <main class="flex-1 overflow-auto pb-14 lg:pb-0">
    <router-outlet />
  </main>

  <!-- Mobile gallery bottom bar (< md only) -->
  @if (auth.isAuthenticated() && isGalleryRoute()) {
    <div class="lg:hidden fixed bottom-0 left-0 right-0 z-50 flex items-center justify-between px-2 py-1 bg-[var(--mat-sys-surface-container)] border-t border-[var(--mat-sys-outline-variant)] safe-area-pb">
      <!-- Type menu -->
      <button mat-icon-button [matMenuTriggerFor]="mobileTypeMenu">
        <mat-icon>photo_library</mat-icon>
      </button>
      <mat-menu #mobileTypeMenu="matMenu">
        <button mat-menu-item (click)="onTypeChange('')">
          <span [class.font-bold]="!store.filters().type">{{ 'gallery.all_photos' | translate }}</span>
        </button>
        @for (t of store.types(); track t.id) {
          <button mat-menu-item (click)="onTypeChange(t.id)">
            <span [class.font-bold]="store.filters().type === t.id">{{ t.label }} ({{ t.count }})</span>
          </button>
        }
      </mat-menu>

      <!-- Sort menu -->
      <button mat-icon-button [matMenuTriggerFor]="mobileSortMenu">
        <mat-icon>sort</mat-icon>
      </button>
      <mat-menu #mobileSortMenu="matMenu">
        @if (sortGroups(); as groups) {
          @for (group of groups; track group[0]; let last = $last) {
            @for (opt of group[1]; track opt.column) {
              <button mat-menu-item (click)="onSortChange(opt.column)">
                <span [class.font-bold]="store.filters().sort === opt.column">{{ opt.label }}</span>
              </button>
            }
            @if (!last) {
              <mat-divider />
            }
          }
        } @else {
          <button mat-menu-item (click)="onSortChange('aggregate')">{{ 'gallery.sort_aggregate' | translate }}</button>
          <button mat-menu-item (click)="onSortChange('aesthetic')">{{ 'gallery.sort_aesthetic' | translate }}</button>
          <button mat-menu-item (click)="onSortChange('date_taken')">{{ 'gallery.sort_date' | translate }}</button>
        }
        <mat-divider />
        <button mat-menu-item (click)="toggleSortDirection()">
          <mat-icon>{{ store.filters().sort_direction === 'DESC' ? 'arrow_downward' : 'arrow_upward' }}</mat-icon>
          {{ store.filters().sort_direction === 'DESC' ? ('gallery.sort_desc' | translate) : ('gallery.sort_asc' | translate) }}
        </button>
      </mat-menu>

      <!-- Search toggle -->
      <button mat-icon-button (click)="mobileSearchOpen.set(!mobileSearchOpen())">
        <mat-icon>search</mat-icon>
      </button>

      <!-- Slideshow toggle -->
      <button mat-icon-button (click)="store.slideshowActive.set(!store.slideshowActive())">
        <mat-icon [style.color]="store.slideshowActive() ? 'var(--mat-sys-primary)' : ''">slideshow</mat-icon>
      </button>

      <!-- Filter drawer toggle -->
      <button
        mat-icon-button
        (click)="store.filterDrawerOpen.set(!store.filterDrawerOpen())"
        [matBadge]="store.activeFilterCount() || null"
        matBadgeColor="primary"
        matBadgeSize="small"
      >
        <mat-icon>tune</mat-icon>
      </button>

      <!-- Photo count -->
      <span class="text-xs opacity-70 min-w-[3ch] text-center">{{ store.total() }}</span>
    </div>
  }
</div>
